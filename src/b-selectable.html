<element name="b-selectable">
    <style>        
    </style>
        
    <script>
        var KEY = {
            ENTER: 13,
            LEFT: 37,
            UP: 38,
            RIGHT: 39,
            DOWN: 40,
        };

        ({
            elementRole: 'listbox',
            elementLabel: 'Selectable list',
            itemsRole: 'option',

            get selectedItemIndex() {
                return Number(this.getAttribute('selected'));
            },

            createdCallback: function() {
                this.handleAria();
                if (this.hasAttribute('selected')) {
                    this.selectedChanged(null, this.getAttribute('selected'));
                }
                this.addListeners();
            },

            handleAria: function() {
                this.tabIndex = 0;
                this.setAttribute('role', this.elementRole);
                this.setAttribute('aria-label', this.elementLabel);
                this.getItems().forEach(function(item) {
                    item.setAttribute('role', this.itemsRole);
                }, this);
            },

            addListeners: function() {
                this.addEventListener('click', this.clickHandler.bind(this), false);
                this.addEventListener('keydown', this.keydownHandler.bind(this), false);
                this.addEventListener('focus', this.focusHandler.bind(this), false);
            },

            attributeChangedCallback: function(name, oldValue, newValue) {
                if (name === 'selected') this.selectedChanged(oldValue, this.getAttribute(name));
            },

            selectedChanged: function(oldValue, newValue) {
                this.dispatchEvent(
                    new CustomEvent('b-select', { detail: { item: newValue } })
                );
                if (oldValue !== null) {
                    this.getItem(oldValue).classList.remove('b-selectable-selected');
                    this.getItem(oldValue).removeAttribute('aria-selected');
                }
                this.getItem(newValue).classList.add('b-selectable-selected');
                this.getItem(newValue).setAttribute('aria-selected', 'true');
            },

            focusHandler: function(e) {
                if (!this.hasAttribute('selected')) {
                    this.selectFirst();
                }
            },

            clickHandler: function(e) {
                var itemIndex =  this.getItems().indexOf(e.target);
                if (itemIndex !== -1) {
                    this.select(itemIndex);
                    this.activate();
                }
            },

            keydownHandler: function(e) {
                switch(e.keyCode) {
                    case KEY.ENTER: {
                        this.activate();
                        break;
                    }
                    case KEY.DOWN: {
                        this.selectNextItem();
                        break;
                    }
                    case KEY.UP: {
                        this.selectPreviousItem();
                        break;
                    }
                    default:
                        return;
                }
            },

            activate: function() {
                this.dispatchEvent(
                    new CustomEvent('b-activate', { detail: { item: this.getAttribute('selected') } })
                );
            },

            select: function(index) {
                this.setAttribute('selected', index);
            },

            selectFirst: function() {
                if (this.getItemCount() > 0) {
                    this.select(0);
                }
            },

            selectNextItem: function() {
                if (this.selectedItemIndex < this.getItemCount() - 1) {
                    this.select(this.selectedItemIndex + 1);
                }
            },

            selectPreviousItem: function() {
                if (this.selectedItemIndex > 0) {
                    this.select(this.selectedItemIndex - 1);
                }
            },

            getItem: function(pos) {
                return this.getItems()[pos] || null;
            },

            getItemCount: function() {
                return this.getItems().length;
            },

            getItems: function() {
                var target = this.getAttribute('target');
                var nodes = target ? this.querySelectorAll(target) : this.children;
                return Array.prototype.slice.call(nodes, 0);
            }
        });
    </script>
</element>